<!doctype html>
<html>

<head>
	<title>live chat</title>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="img/favicon.png">
	<link rel="stylesheet" href="css/materialize.css">
	<link rel="stylesheet" href="css/materialize-icons.css">
	<link rel="stylesheet" href="css/style.css">
</head>

<body>
	<script src="/socket.io/socket.io.js"></script>
	<script src="js/jquery-1.11.1.js"></script>
	<script src="js/materialize.js"></script>
	<script>
		$(() => {
			//SOUND
			playSound = (time = 1000, freq = 300, type = 'sine', volume = 0.5, pretty = true) => { //sine triangle sawtooth square
				let ctx = new AudioContext(); // one context per document
				let osc = ctx.createOscillator(); // instance of oscillator
				let vol = ctx.createGain();
				vol.gain.value = volume; // from 0 to 1, 1 full volume, 0 is muted
				osc.type = type; // this is the default - also square, sawtooth, triangle
				osc.frequency.value = freq; //Hz
				// osc.connect(ctx.destination); // connect it to the destination
				osc.connect(vol); // connect osc to vol
				vol.connect(ctx.destination); // connect vol to context destination
				osc.start(ctx.currentTime); // start the oscillator
				if (pretty) vol.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + time / 1000); //pretty sound
				setTimeout(() => {
					osc.stop(ctx.currentTime); // stop 2 seconds after the current time
					vol.disconnect(ctx.destination);
					osc.disconnect(vol);
					osc = vol = ctx = null;
				}, time);
			}


			//SOCKET
			let socket = io();
			let ioChat = io('/chat');

			privMessage = (to) => {
				socket.emit('priv message', to, prompt(`Your message to ${to}...`));
			}
			//priv message
			socket.on('priv message', (name, date, msg) => {
				alert(`From: ${name}\nDate: ${date}\nMessage: ${msg}`);
			});

			socket.on('online users', (users) => {
				$('#online-users').html(users.map(v=>`${v}<span onclick="privMessage('${v}')">&#x1F4DD;</span>`).join(', '));
			});

			//previous messages
			ioChat.on('previous messages', (messages) => {
				if(messages.length){
					$('#messages').html(messages.map(v=>`<li>${v.name} (${v.date}) : ${v.msg}</li>`).join(''));
					$('#messages').animate({ scrollTop: $('#messages')[0].scrollHeight }, 600);
				}
			});

			//nick-change
			$('form#nick-change').submit((e) => {
				e.preventDefault();
				ioChat.emit('nick change', $('#my-nick').val());
				return false;
			});
			ioChat.on('nick changed or not', (nick, changed) => {
				if (!changed) alert(`Incorrect nickname`);
				$('#my-nick').attr('placeholder', nick).val('');
			});

			//who is typing
			$('#message').keyup(() => {
				ioChat.emit('im typing', true);
			});
			$('#message').blur(() => {
				ioChat.emit('im typing', false);
			});
			ioChat.on('typers', (typers) => {
				if (typers.length) $('#typers').text(`${typers.join(', ')} ${(typers.length > 1) ? 'are' : 'is'} typing...`);
				else $('#typers').text(``);
			});

			//message send
			$('form#message-send').submit(() => {
				ioChat.emit('message send', $('#message').val());
				$('#message').val('');
				$('form#message-send button').attr('disabled', 'disabled');
				setTimeout(() => {
					$('form#message-send button').removeAttr('disabled');
				}, 2000);
				return false;
			});
			ioChat.on('message sent', (name, date, msg) => {
				$('#messages').append($('<li>').text(`${name} (${date}) : ${msg}`));
				if ($('#autoscroll')[0].checked) $('#messages').animate({ scrollTop: $('#messages')[0].scrollHeight }, 600);
				playSound(); //time, freq, type, volume
			});

			//join room
			$('form#join-room').submit(() => {
				ioChat.emit('room join', $('#my-room').val());
				$('#my-room').val('');
				return false;
			});

			joinToRoom = (room) => {
				$('#my-room').val(room.split('(')[0]);
			}
			//existing rooms
			ioChat.on('existing rooms', (rooms) => {
				$('#existing-rooms-length').text(rooms.length);
				$('#existing-rooms').html(rooms.map(v=>`<span onclick="joinToRoom('${v}')">${v}</span>`).join(', '));
			});

			messageToRoom = (to) => {
				ioChat.emit('message to room', to, prompt(`Your message to ${to}...`));
			}
			leaveRoom = (room) => {
				if(confirm(`Do you want to leave room ${room}?`)) ioChat.emit('leave room', room);
			}
			//my rooms update
			ioChat.on('my rooms', (rooms) => {
				$('#my-rooms').html(rooms.map(v=>`${v}<span onclick="messageToRoom('${v}')">&#x1F4DD;</span><span onclick="leaveRoom('${v}')">&#x274C</span>`).join(', '));
			});

			//message to room
			ioChat.on('message to room', (name, date, msg, to) => {
				playSound(1000, 3000, 'sawtooth', 0.3, true);
				alert(`From: ${name}\nRoom: ${to}\nDate: ${date}\nMessage: ${msg}`);
			});
		});
	</script>

	<main>

		<form id="nick-change">
			<div class="input-field">
				<input type="text" id="my-nick" placeholder="Your nickname" autocomplete="off" data-length="10">
				<label for="my-nick">Your nickname</label>
			</div>
			<!-- <button>Change nick</button> -->
			<button class="waves-effect waves-light btn blue"><i class="material-icons right">account_circle</i>Change nick</button>
		</form>

		<ul id="messages"></ul>

		<form id="message-send">
			<div class="input-field">
				<input type="text" id="message" autocomplete="off" data-length="120">
				<label for="message">Your message</label>
			</div>
			<button class="waves-effect waves-light btn blue"><i class="material-icons right">chat</i>Send</button>
			<label>
				<input type="checkbox" id="autoscroll" checked="checked">
				<span>Autoscroll</span>
			</label>
		</form>

	</main>

	<aside id="typers"></aside>

	<aside>
		Online users: <span id="online-users"></span>
	</aside>

	<section>
		<form id="join-room">
			<div class="input-field">
				<input type="text" id="my-room" autocomplete="off" data-length="10">
				<label for="my-room">Room name</label>
			</div>
			<button class="waves-effect waves-light btn blue"><i class="material-icons right">group_add</i>Join room</button>
		</form>
		<div>
			My rooms: <span id="my-rooms"></span>
		</div>
		<div>
			Existing rooms[<span id="existing-rooms-length"></span>]: <span id="existing-rooms"></span>
		</div>
	</section>
</body>

</html>