<!doctype html>
<html>

<head>
	<title>Socket.IO</title>
	<style>
		ul{
			list-style-type: disc;
			height: 100px;
			overflow-y: scroll;
		}

		form {
			display: inline-block;
		}
	</style>
</head>

<body>
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
	<script>
		$(function () {
			let socket = io();
			let ioChat = io('/chat');

			socket.on('online users', (users) => {
				$('#online-users').text(users.join(', '));
			});

			//nick-change
			$('nav form#nick-change').submit(() => {
				ioChat.emit('nick change', $('#my-nick').val());
				return false;
			});
			ioChat.on('nick changed or not', (nick, changed) => {
				if (!changed) alert(`Incorrect nickname`);
				$('#my-nick').attr('placeholder', nick).val('');
			});

			//who is typing
			$('#message').keyup(() => {
				ioChat.emit('im typing', true);
			});
			$('#message').blur(() => {
				ioChat.emit('im typing', false);
			});
			ioChat.on('typers', (typers) => {
				if (typers.length) $('#typers').text(`${typers.join(', ')} ${(typers.length > 1) ? 'are' : 'is'} typing...`);
				else $('#typers').text(``);
			});

			//message send
			$('form#message-send').submit(() => {
				ioChat.emit('message send', $('#message').val());
				$('#message').val('');
				return false;
			});
			ioChat.on('message sent', (name, date, msg) => {
				//let x = $("#messages").scrollTop();
				//let y = $("#messages")[0].scrollHeight;
				// autoscroll: y-x <= 160
				$('#messages').append($('<li>').text(`${name} (${date}) : ${msg}`));
				if ($('#autoscroll')[0].checked) $("#messages").scrollTop($("#messages")[0].scrollHeight);
			});

		});
	</script>

	<nav>
		<form id="nick-change">
			<input id="my-nick" placeholder="Your nickname" autocomplete="off" /> <button>Change nick</button>
		</form>
	</nav>

	<ul id="messages"></ul>
	<form id="message-send">
		<input id="message" placeholder="Your message" autocomplete="off" /> <button>Send</button>
		<input id="autoscroll" type="checkbox" checked> Autoscroll
	</form>

	<aside id="typers"></aside>

	<aside>
		Online users: <span id="online-users"></span>
	</aside>
</body>

</html>