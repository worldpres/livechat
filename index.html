<!doctype html>
<html>

<head>
	<title>Socket.IO</title>
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
	<script>
		$(() => {
			//SOUND
			playSound = (time = 1000, freq = 300, type = 'sine', volume = 0.5, pretty = true) => { //sine triangle sawtooth square
				let ctx = new AudioContext(); // one context per document
				let osc = ctx.createOscillator(); // instance of oscillator
				let vol = ctx.createGain();
				vol.gain.value = volume; // from 0 to 1, 1 full volume, 0 is muted
				osc.type = type; // this is the default - also square, sawtooth, triangle
				osc.frequency.value = freq; //Hz
				// osc.connect(ctx.destination); // connect it to the destination
				osc.connect(vol); // connect osc to vol
				vol.connect(ctx.destination); // connect vol to context destination
				osc.start(ctx.currentTime); // start the oscillator
				if (pretty) vol.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + time / 1000); //pretty sound
				setTimeout(() => {
					osc.stop(ctx.currentTime); // stop 2 seconds after the current time
					vol.disconnect(ctx.destination);
					osc.disconnect(vol);
					osc = vol = ctx = null;
				}, time);
			}


			//SOCKET
			let socket = io();
			let ioChat = io('/chat');

			privMessage = (to) => {
				socket.emit('priv message', to, prompt(`Your message to ${to}...`));
			}
			//priv message
			socket.on('priv message', (name, date, msg) => {
				alert(`From: ${name}\nDate: ${date}\nMessage: ${msg}`);
			});

			socket.on('online users', (users) => {
				$('#online-users').html(users.map(v=>`${v}<span onclick="privMessage('${v}')">&#x1F4DD;</span>`).join(', '));
			});

			//nick-change
			$('nav form#nick-change').submit(() => {
				ioChat.emit('nick change', $('#my-nick').val());
				return false;
			});
			ioChat.on('nick changed or not', (nick, changed) => {
				if (!changed) alert(`Incorrect nickname`);
				$('#my-nick').attr('placeholder', nick).val('');
			});

			//who is typing
			$('#message').keyup(() => {
				ioChat.emit('im typing', true);
			});
			$('#message').blur(() => {
				ioChat.emit('im typing', false);
			});
			ioChat.on('typers', (typers) => {
				if (typers.length) $('#typers').text(`${typers.join(', ')} ${(typers.length > 1) ? 'are' : 'is'} typing...`);
				else $('#typers').text(``);
			});

			//message send
			$('form#message-send').submit(() => {
				ioChat.emit('message send', $('#message').val());
				$('#message').val('');
				$('form#message-send button').attr('disabled', 'disabled');
				setTimeout(() => {
					$('form#message-send button').removeAttr('disabled');
				}, 2000);
				return false;
			});
			ioChat.on('message sent', (name, date, msg) => {
				$('#messages').append($('<li>').text(`${name} (${date}) : ${msg}`));
				if ($('#autoscroll')[0].checked) $('#messages').animate({ scrollTop: $('#messages')[0].scrollHeight }, 600);
				playSound(); //time, freq, type, volume
			});

			//join room
			$('form#join-room').submit(() => {
				ioChat.emit('room join', $('#my-room').val());
				$('#my-room').val('');
				return false;
			});

			//existing rooms
			ioChat.on('existing rooms', (rooms) => {
				$('#existing-rooms-length').text(rooms.length);
				$('#existing-rooms').text(rooms.join(', '));
			});

			simpleMessage = (to) => {
				ioChat.emit('simple message', to, prompt(`Your message to ${to}...`));
			}
			//my rooms update
			ioChat.on('my rooms', (rooms) => {
				$('#my-rooms').html(rooms.map(v=>`${v}<span onclick="simpleMessage('${v}')">&#x1F4DD;&#x274C</span>`).join(', '));
			});

			//simple message
			ioChat.on('simple message', (name, date, msg, to) => {
				alert(`From: ${name}\nRoom: ${to}\nDate: ${date}\nMessage: ${msg}`);
			});
		});
	</script>

	<nav>
		<form id="nick-change">
			<input id="my-nick" placeholder="Your nickname" autocomplete="off"> <button>Change nick</button>
		</form>
	</nav>

	<main>
		<ul id="messages"></ul>
		<form id="message-send">
			<input id="message" placeholder="Your message" autocomplete="off"> <button>Send</button>
			<input id="autoscroll" type="checkbox" checked> Autoscroll
		</form>
	</main>

	<aside id="typers"></aside>

	<aside>
		Online users: <span id="online-users"></span>
	</aside>

	<section>
		<form id="join-room">
			<input id="my-room" placeholder="Room name" autocomplete="off"> <button>Join room</button>
		</form>
		<div>
			My rooms: <span id="my-rooms"></span>
		</div>
		<div>
			Existing rooms(<span id="existing-rooms-length"></span>): <span id="existing-rooms"></span>
		</div>
	</section>
</body>

</html>